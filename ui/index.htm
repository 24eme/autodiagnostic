<div id="questionnaire">

  <div id="progress-bar" class="progress position-fixed top-0 w-100" style="height: 0.5rem;">
    <progress v-for="categorie in categories" v-bind:id="categorie.id" v-bind:style="'width: ' + calculateCategorieWidth(categorie) + '%; background: ' + categorie.opacite" v-bind:value="updateCategorieProgress(categorie)" max="100"></progress>
  </div>

  <include href="header.htm">

  <div class="col-6 mx-auto pb-3">

    <transition-group tag="div" class="container-slider" v-bind:name="(indexCourant > indexPrecedent) ? 'slide' : (indexCourant < indexPrecedent) ? 'slideback' : 'slidestatic'">

      <section id="page_home" v-show="indexCourant == -1" class="text-center" key="-1">

        <p class="text-muted mb-5 fs-5">
          Afin de vous faire une idée du positionnement de votre exploitation en terme d'environnement et de développement durable dans le vignoble, le BIVC met à disposition cet outil d'autodiagnostic vous permettant de vous évaluer sur ces questions environnementales.
        </p>

        <div id="startup-content" v-if="questionnaireStarted">
          <div class="mb-5 p-2 bg-light border rounded">
            <p class="text-center m-0">
            <i class="bi-journal-check" role="img" aria-label="Questions répondues"></i> Vous avez répondu à {% getReponsesIds().length %} question(s) sur un total de {% getInitialNbQuestions() %}.
            </p>
          </div>

          <div class="col-md-8 mx-auto">
            <p class="text-center lead">
              Plusieurs choix s'offrent à vous :
            </p>
            <div class="d-grid gap-3 d-sm-flex justify-content-sm-center">
              <button type="button" class="btn btn-outline-danger" v-on:click="reset">
                <i class="bi-exclamation-triangle-fill"></i> Recommencer le questionnaire
              </button>
              <button class="btn btn-primary" v-on:click="passerQuestionsEnAttentesReponses()">Continuer le questionnaire</button>
            </div>
          </div>
        </div>
        <div v-else id="startup-content">
          <div class="text-center">
            <div class="mb-5 alert alert-primary d-flex align-items-center" role="alert">
              <div class="border-end">
                <i class="fs-2 bi-info-circle-fill"></i>
              </div>
              <div>
                En répondant à ce questionnaire, vous acceptez l'utilisation de vos données par le BIVC à des fins de traitement statistiques collectives
                (<a href="#" class="alert-link">Charte environnementale Centre Loire</a>).
              </div>
            </div>
            <button class="btn btn-primary" v-on:click="deplacer(0)">Commencer le questionnaire</button>
          </div>
        </div>
      </section>

      <section v-for="(question, index) in getQuestions()" v-show="indexCourant == index" v-bind:key="index" v-bind:id="'question_' + question.id">
        <div v-if="question.type === 'categorie'" class="p-5 categorie" v-bind:style="'color: ' + question.couleur_texte + '; background-color: ' + question.couleur + ';'" v-on:click="deplacer(index+1)">
          <h2 class="py-5 m-0"><span class="bi-chevron-right">{% question.libelle %}</span></h2>
          <p class="pb-5 m-0" v-html="question.complement_information"></p>
        </div>
        <div v-if="question.type === 'question'" class="ps-2 question">
          <div class="question-title">
            <h2 class="h4 p-3" v-bind:style="'color: ' + question.categorie_couleur_texte + '; background-color: ' +  question.categorie_couleur + ';'"><strong class="opacity-75">{% question.num + 1  %}.</strong> {% question.libelle %}</h2>
          </div>
          <div class="question-content" v-bind:style="'border-left-color: ' +  question.categorie_couleur + ';'">
            <p v-if="question.complement_information" class="bg-light p-2 text-muted small" v-html="question.complement_information"></p>
            <div class="list-group my-4" v-if="question.reponses">
              <div v-for="reponse in question.reponses">
                <label class="list-group-item list-group-item-action py-3" v-bind:class="{ active: reponses[question.id] == reponse.id }" role="button">
                  <input v-if="question.multiple" v-model="reponses[question.id]" v-bind:id="reponse.id" class="form-check-input me-1" type="checkbox" v-bind:value="reponse.id" v-on:change="storeReponses(question)">
                  <input v-else-if="reponse.question" v-model="reponses[question.id]" class="form-check-input me-1" v-bind:name="question.id" type="radio" v-bind:value="reponse.id" v-on:change="storeReponses(question)">
                  <input v-else v-model="reponses[question.id]" class="form-check-input me-1" v-on:click="deplacer(index + 1)" v-bind:name="question.id" type="radio" v-bind:value="reponse.id" v-on:change="storeReponses(question)">
                  {% reponse.libelle %}
                </label>
                <div class="col-6" v-if="reponse.question && reponses[question.id] !== undefined && (reponses[question.id] == reponse.id || (reponses[question.id].length && reponses[question.id].includes(reponse.id)))">
                  <div class="py-3 input-group">
                    {% reponse.question.libelle %}&nbsp;
                    <input v-model="reponses[reponse.question.id]" type="text" class="form-control" v-bind:name="reponse.question.id" v-on:change="storeReponses(question)" v-on:keyup.enter="deplacer(index + 1)"/>
                    <span class="input-group-text" v-show="reponse.question.unite" v-html="reponse.question.unite"></span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6" v-else>
              <div class="my-4 input-group">
                <input v-if="question.format && question.format == 'date'" v-model="reponses[question.id]" type="date" class="form-control" v-bind:name="question.id" v-on:change="storeReponses(question)" v-on:keyup.enter="deplacer(index + 1)"/>
                <input v-else v-model="reponses[question.id]" type="number" min=0 :max="(question.unite === '%') ? 100 : null" class="form-control" v-bind:name="question.id" v-on:change="storeReponses(question)" v-on:keyup.enter="deplacer(index + 1)"/>
                <span class="input-group-text" v-show="question.unite" v-html="question.unite"></span>
              </div>
            </div>
            <div class="d-grid d-md-flex justify-content-between my-4">
              <button class="btn btn-sm btn-light" v-on:click="nonConcerne(index)">Non concerné</button>
              <button class="btn" v-bind:style="'color: ' + getCategorieTexteCouleur(indexCourant) + '; background-color: ' + getCategorieCouleur(indexCourant) + ';'" v-on:click="deplacer(indexCourant + 1)">Suivant <span class="bi-chevron-compact-right"></span></button>
            </div>
          </div>
        </div>
      </section>

      <section v-show="isTermine" v-bind:key="nombreQuestionsTotal" class="container-fluid py-5 text-center">
        <h1 class="display-5 fw-bold"><span class="bi bi-hand-thumbs-up"></span> Bravo !</h1>
        <p class="fs-4">Vous êtes arrivé à la fin du questionnaire.</p>

        <div class="my-5 bg-light border rounded">
          <p class="text-center my-5" v-if="hasQuestionsEnAttentesReponses()">
            Vous n'avez pas répondu à l'ensemble du questionnaire.<br />
            <button type="button" class="btn btn-primary mt-2" v-on:click="passerQuestionsEnAttentesReponses()">Répondre aux questions non repondues</button>
          </p>
        </div>

        <div class="col-md-8 mx-auto">
          <p class="text-center lead">
            Vous pouvez vérifier vos réponses avant de valider votre auto-diagnostic, ou confirmer et voir vos résultats.
          </p>
          <div class="d-grid gap-3 d-sm-flex justify-content-sm-center">
            <button type="button" class="btn btn btn-outline-primary" v-on:click="passerToutesQuestions()">Vérifier mes réponses</button>
            <a v-if="hasQuestionsEnAttentesReponses()" class="btn btn-primary disabled" aria-disabled="true" href="#">Voir les résultats</a>
            <form name="synthetiserForm" v-if="!hasQuestionsEnAttentesReponses()" action="{{ 'synthetiser' | alias }}" method="post" enctype="multipart/form-data">
              <input class="d-none" type="file" id="jsonReponses" name="jsonReponses" accept=".json,application/json">
              <button type="button" v-on:click="synthetiser()" class="btn btn-primary">Voir les résultats</button>
            </form>
          </div>
        </div>
      </section>

    </transition-group>

    <div class="fixed-bottom col-6 mx-auto py-1" v-if="indexCourant > -1 && !isTermine">
      <div class="row">
        <div class="col-3">
          <button type="button" z-index="-1" title="Retour au début" class="btn btn-outline-dark border me-2" v-on:click="intro()"><span class="bi bi-chevron-double-left"></span></button>
          <button type="button" z-index="-1" class="btn btn-outline-dark border" v-on:click="deplacer(indexPrecedent, true)"><span class="bi bi-chevron-compact-left"></span>Précédent</button>
        </div>
        <div class="col align-self-center text-center">
          <span class="text-muted">Progression : {% getProgress() %}%</span>
        </div>
        <div class="col-3">
          <button type="button" class="btn float-end" v-bind:style="'color: ' + getCategorieTexteCouleur(indexCourant) + '; background-color: ' + getCategorieCouleur(indexCourant) + ';'" v-if="indexCourant+1 < nombreQuestionsTotal" v-on:click="deplacer(indexCourant + 1)">Suivant<span class="bi-chevron-compact-right"></span></button>
          <button type="button" class="btn btn-success float-end" v-if="indexCourant+1 >= nombreQuestionsTotal" v-on:click="terminer()">Terminer</button>
        </div>
      </div>
    </div>
  </div>

  <div class="position-fixed bottom-0 start-0 p-1 opacity-25">
    <span v-on:click="switchModeQuestions">
      <i v-if="modeQuestionsNonRepondues" class="bi-file cursor-help" title="Mode non répondues"></i>
      <i v-else class="bi-file-text cursor-help" title="Mode vérification"></i>
    </span>
  </div>

</div>
